<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Resume</title>

  <link rel="stylesheet" href="style.css" />

  <style>
    canvas {
      display: block;
    }

    .pdf-page {
      position: relative;
      background: transparent;
      overflow: hidden;
      margin-bottom: 18px; /* intentional grey gap */
      line-height: 0;
      border: 0;
      outline: 0;
      box-shadow: none;
    }

    /* Invisible clickable link overlays */
    .link-overlay {
      position: absolute;
      z-index: 10;
      background: transparent;
      cursor: pointer;
      text-decoration: none;
    }
  </style>
</head>

<body>
  <div class="page">
    <header>
      <nav class="top-nav">
        <a href="index.html">Home</a>
        <a href="about.html">About</a>
        <a class="active" href="resume.html">Resume</a>
        <a href="activities.html">Activities</a>
        <a href="writings.html">Blog</a>
      </nav>
    </header>

    <main>
      <p id="pdf-fallback" style="display:none;">Resume failed to load.</p>
      <div id="pdf-container"></div>
    </main>
    <footer>
      <p class="footer-text">&copy; 2025 Tristan Yan-Klassen</p>
    </footer>
  </div>

  <script type="module">
    import * as pdfjsLib from "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.8.69/build/pdf.mjs";

    const PDF_PATH = "./resume.pdf";
    const MAX_WIDTH = 880;

    /* ============================
       MANUAL LINK OVERLAYS (FINAL)
       ============================ */
    const LINK_OVERLAYS = [
      {
        page: 1,
        url: "mailto:tyanklas@uwaterloo.ca",
        rect: [199, 716, 308, 732],
      },
      {
        page: 1,
        url: "https://tristan-yk.github.io/",
        rect: [314, 716, 405, 732],
      },
      {
        page: 1,
        url: "https://linkedin.com/in/tristanyanklassen",
        rect: [410, 716, 510, 732],
      },
    ];

    const container = document.getElementById("pdf-container");
    const fallback = document.getElementById("pdf-fallback");

    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.8.69/build/pdf.worker.mjs";

    function fail(err) {
      console.error(err);
      fallback.style.display = "block";
      container.innerHTML = "";
    }

    function getRenderWidth() {
      return Math.min(
        document.querySelector(".page")?.clientWidth ?? window.innerWidth,
        MAX_WIDTH
      );
    }

    function pdfRectToCss(viewport, rect) {
      const [x1, y1, x2, y2] = rect;
      const p1 = viewport.convertToViewportPoint(x1, y1);
      const p2 = viewport.convertToViewportPoint(x2, y2);

      const left = Math.min(p1[0], p2[0]);
      const top = Math.min(p1[1], p2[1]);
      const width = Math.abs(p2[0] - p1[0]);
      const height = Math.abs(p2[1] - p1[1]);

      return { left, top, width, height };
    }

    function addLinkOverlays(pageWrap, viewport, pageNum) {
      LINK_OVERLAYS
        .filter(o => o.page === pageNum)
        .forEach(o => {
          const css = pdfRectToCss(viewport, o.rect);

          const a = document.createElement("a");
          a.className = "link-overlay";
          a.href = o.url;
          a.target = "_blank";
          a.rel = "noopener";

          a.style.left = `${css.left}px`;
          a.style.top = `${css.top}px`;
          a.style.width = `${css.width}px`;
          a.style.height = `${css.height}px`;

          pageWrap.appendChild(a);
        });
    }

    async function render() {
      try {
        const pdf = await pdfjsLib.getDocument(PDF_PATH).promise;

        container.innerHTML = "";
        fallback.style.display = "none";

        const dpr = window.devicePixelRatio || 1;
        const renderWidth = getRenderWidth();

        for (let n = 1; n <= pdf.numPages; n++) {
          const page = await pdf.getPage(n);
          const unscaled = page.getViewport({ scale: 1 });

          // Integer CSS sizing to avoid seams
          const scale0 = renderWidth / unscaled.width;
          const cssW = Math.round(unscaled.width * scale0);
          const cssH = Math.round(unscaled.height * scale0);
          const scale = cssW / unscaled.width;

          const viewport = page.getViewport({ scale });
          const renderViewport = viewport.clone({ scale: viewport.scale * dpr });

          const pageWrap = document.createElement("div");
          pageWrap.className = "pdf-page";
          pageWrap.style.width = `${cssW}px`;
          pageWrap.style.height = `${cssH}px`;
          container.appendChild(pageWrap);

          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d", { alpha: false });

          canvas.width = Math.floor(renderViewport.width);
          canvas.height = Math.floor(renderViewport.height);
          canvas.style.width = `${cssW}px`;
          canvas.style.height = `${cssH}px`;
          canvas.style.position = "absolute";
          canvas.style.left = "0";
          canvas.style.top = "0";
          canvas.style.zIndex = "0";

          pageWrap.appendChild(canvas);

          await page.render({
            canvasContext: ctx,
            viewport: renderViewport
          }).promise;

          addLinkOverlays(pageWrap, viewport, n);
        }
      } catch (err) {
        fail(err);
      }
    }

    render();
    window.addEventListener("resize", () => location.reload());
  </script>
</body>
</html>
